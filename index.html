<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>The Morning Alchemist</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden; /* Prevent scroll */
}

.container {
  width: 94%;
  max-width: 480px;
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  height: 100%;
}

h1 {
  font-size: 1.4rem;
  margin: 0 0 10px 0;
  background: linear-gradient(to right, #60a5fa, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.phase {
  font-size: 0.9rem;
  color: #93c5fd;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 5px;
}

.movement {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 5px 0;
  color: #fff;
  min-height: 3.5rem; /* Reserve space */
  display: flex;
  align-items: center;
  justify-content: center;
}

.timer {
  font-size: 4.5rem;
  font-weight: 300;
  margin: 10px 0;
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.description {
  font-size: 0.95rem;
  opacity: 0.9;
  line-height: 1.5;
  background: rgba(255,255,255,0.05);
  padding: 12px;
  border-radius: 12px;
  margin: 10px 0;
  min-height: 60px; /* Consistent height */
  display: flex;
  align-items: center;
  justify-content: center;
}

.bandha {
  font-size: 0.9rem;
  color: #a7f3d0;
  font-weight: 500;
  margin-bottom: 10px;
}

.next {
  font-size: 0.85rem;
  opacity: 0.6;
  margin-top: 5px;
  min-height: 1.2rem;
}

.controls {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  gap: 12px;
}

.controls button {
  padding: 14px 20px;
  font-size: 1.1rem;
  border-radius: 14px;
  border: none;
  background: #2563eb;
  color: white;
  cursor: pointer;
  touch-action: manipulation;
  transition: transform 0.1s, opacity 0.2s;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.controls button:active {
  transform: scale(0.96);
}

.secondary { background: #334155 !important; box-shadow: none !important; }

#progressWrapper {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 20px 5%;
  box-sizing: border-box;
  background: linear-gradient(to top, #0f172a 20%, transparent);
}

#progressTime {
  text-align: center;
  font-size: 0.8rem;
  opacity: 0.7;
  margin-bottom: 8px;
}

#progressContainer {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.15);
  border-radius: 6px;
  overflow: hidden;
}

#progressBar {
  height: 100%;
  width: 0%;
  background: linear-gradient(to right, #38bdf8, #818cf8);
  border-radius: 6px;
  transition: width 1s linear;
}

/* Hidden Video for Wake Lock */
#wakelock {
  position: absolute;
  top: 0;
  left: 0;
  width: 1px;
  height: 1px;
  opacity: 0.01;
  pointer-events: none;
}
</style>
</head>

<body>

<div class="container">
  <h1>‚ö° The Morning Alchemist</h1>

  <div class="phase" id="phase"></div>
  <div class="movement" id="movement"></div>
  <div class="timer" id="timer">00:00</div>
  <div class="description" id="description"></div>
  <div class="bandha" id="bandha"></div>
  <div class="next" id="next"></div>

  <div class="controls">
    <button class="secondary" onclick="prev()">‚èÆ</button>
    <button id="btnStart" onclick="start()">‚ñ∂ Start</button>
    <button id="btnPause" onclick="pause()" style="display:none; background:#ef4444;">‚è∏ Pause</button>
    <button class="secondary" onclick="next(false)">‚è≠</button>
  </div>
  
  <div class="controls" style="margin-top:10px;">
     <button class="secondary" onclick="reset()" style="font-size:0.9rem; padding: 10px 16px; background: transparent !important; border: 1px solid #334155;">üîÑ Reset</button>
  </div>
</div>

<div id="progressWrapper">
  <div id="progressTime"></div>
  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
</div>

<video id="wakelock" loop muted playsinline>
  <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb20AAABtb292AAAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAAA+gAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAABkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="video/mp4">
</video>

<script>
/* SERVICE WORKER REGISTRATION */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

/* PRACTICE ROUTINE DATA */
const practice = [
{
  phase: "Phase 1: Lymphatic Purge",
  steps: [
    {
      name: "Sacred Shaking",
      time: 120,
      desc: "Bounce from heels. Shake whole body. Exhale 'Ahhh'.",
      bandha: "Relax Pelvic Floor"
    },
    {
      name: "Door of Life Knocking",
      time: 60,
      desc: "Swing torso. Fist taps belly, other hand taps kidneys.",
      bandha: "None"
    }
  ]
},
{
  phase: "Phase 2: The Electric Spine",
  steps: [
    {
      name: "Spinal Flex",
      time: 120,
      desc: "Inhale arch forward, exhale round back. Increase speed.",
      bandha: "Light Mula Bandha"
    },
    {
      name: "Breath of Fire & Squeeze",
      time: 120,
      desc: "Arms 60¬∞. Rapid nose breath. End: Squeeze root, energy to brain.",
      bandha: "Mula + Uddiyana"
    }
  ]
},
{
  phase: "Phase 3: Flow State (VO2 Max)",
  steps: [
    {
      name: "Beast Flow Round 1",
      time: 240,
      desc: "Down Dog ‚Üí Wave ‚Üí Loaded Beast ‚Üí Step Through ‚Üí Crab.",
      bandha: "Core Engaged"
    },
    {
      name: "Beast Flow Round 2",
      time: 240,
      desc: "Faster tempo. Explosive movements. Ujjayi breath.",
      bandha: "Core Engaged"
    }
  ]
},
{
  phase: "Phase 4: Coherence",
  steps: [
    {
      name: "Heart Coherence",
      time: 180,
      desc: "Inhale 5s, Exhale 5s through chest center.",
      bandha: "Heart Focus"
    },
    {
      name: "Elevated Emotion",
      time: 120,
      desc: "Feel Gratitude as if it already happened.",
      bandha: "Emotional Lock"
    }
  ]
}
];

/* STATE VARIABLES */
let s = 0, m = 0;
let time = practice[0].steps[0].time;
let interval = null;
let wakeLock = null;

/* DOM ELEMENTS */
const phaseEl = document.getElementById("phase");
const movementEl = document.getElementById("movement");
const timerEl = document.getElementById("timer");
const descEl = document.getElementById("description");
const bandhaEl = document.getElementById("bandha");
const nextEl = document.getElementById("next");
const progressBar = document.getElementById("progressBar");
const progressTime = document.getElementById("progressTime");
const btnStart = document.getElementById("btnStart");
const btnPause = document.getElementById("btnPause");
const videoHack = document.getElementById("wakelock");

/* AUDIO CONTEXT SETUP */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

/* üîä TRIPLE BEEP FUNCTION */
function tripleBeep() {
  const now = audioCtx.currentTime;
  // Schedule 3 beeps: 0s, 0.2s, 0.4s
  [0, 0.2, 0.4].forEach(delay => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = 880; // A5 note
    osc.type = 'sine';
    
    // Fade in/out to avoid clicking
    gain.gain.setValueAtTime(0, now + delay);
    gain.gain.linearRampToValueAtTime(0.15, now + delay + 0.02);
    gain.gain.linearRampToValueAtTime(0, now + delay + 0.1);
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(now + delay);
    osc.stop(now + delay + 0.15);
  });
}

/* üó£Ô∏è TEXT TO SPEECH FUNCTION */
function speak(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel(); // Stop any previous speech
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.9; // Slightly slower
    utterance.pitch = 1;
    utterance.lang = 'en-US';
    window.speechSynthesis.speak(utterance);
  }
}

/* üî¶ WAKE LOCK FUNCTION */
async function requestWakeLock() {
  // 1. iOS Hack
  try {
    videoHack.play().catch(() => {});
  } catch (err) {}

  // 2. Native API (Android/PC)
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
    } catch (err) {
      console.log('Wake Lock error:', err);
    }
  }
}

/* HELPER: Calculate Total Time */
const totalTime = practice.reduce(
  (sum, p) => sum + p.steps.reduce((a,b)=>a+b.time,0), 0
);

function elapsed() {
  let e = 0;
  for (let i=0;i<s;i++) e += practice[i].steps.reduce((a,b)=>a+b.time,0);
  for (let j=0;j<m;j++) e += practice[s].steps[j].time;
  e += practice[s].steps[m].time - time;
  return e;
}

/* UI RENDERER */
function render() {
  const step = practice[s].steps[m];
  phaseEl.textContent = practice[s].phase;
  movementEl.textContent = step.name;
  descEl.textContent = step.desc;
  bandhaEl.textContent = "Focus: " + step.bandha;

  const nxt = getNext();
  nextEl.textContent = nxt ? `Next ‚Üí ${nxt.name}` : "";

  timerEl.textContent =
    `${Math.floor(time/60).toString().padStart(2,"0")}:${(time%60).toString().padStart(2,"0")}`;

  const el = elapsed();
  progressBar.style.width = `${(el/totalTime)*100}%`;
  progressTime.textContent =
    `${Math.floor(el/60)}:${(el%60).toString().padStart(2,"0")} / ${Math.floor(totalTime/60)}:${(totalTime%60).toString().padStart(2,"0")}`;
}

/* LOGIC CONTROL */
function start() {
  if (interval) return;
  
  // Initialize Audio & Wake Lock
  audioCtx.resume();
  requestWakeLock();
  
  // Update UI Buttons
  btnStart.style.display = 'none';
  btnPause.style.display = 'inline-block';

  // Speak immediately if just starting or resuming
  // (Optional: simple logic to only speak if starting fresh could be added, but repeated is fine)
  if (time === practice[s].steps[m].time) {
     speak(practice[s].steps[m].name);
  }

  interval = setInterval(() => {
    time--;
    if (time < 0) {
      next(true); // Auto next (Timer ended)
    }
    render();
  }, 1000);
}

function pause() {
  clearInterval(interval);
  interval = null;
  
  // Release Wake Lock
  videoHack.pause();
  if (wakeLock) {
    wakeLock.release();
    wakeLock = null;
  }

  // Update UI Buttons
  btnStart.style.display = 'inline-block';
  btnPause.style.display = 'none';
}

function reset() {
  pause();
  s = 0; m = 0;
  time = practice[0].steps[0].time;
  render();
}

function next(auto = false) {
  // If timer ran out (auto=true), play 3 beeps
  if (auto) {
    tripleBeep();
  }

  m++;
  if (m >= practice[s].steps.length) {
    m = 0; s++;
    if (s >= practice.length) {
      finishPractice();
      return;
    }
  }
  
  // Set new time
  time = practice[s].steps[m].time;
  
  // Speak new movement name
  speak(practice[s].steps[m].name);
  
  // If manually skipped, we might need to ensure audioCtx is running
  if (!auto && audioCtx.state === 'suspended') {
      audioCtx.resume();
  }
  
  render();
}

function prev() {
  m--;
  if (m < 0) {
    s--;
    if (s < 0) { s = 0; m = 0; }
    else m = practice[s].steps.length - 1;
  }
  time = practice[s].steps[m].time;
  speak(practice[s].steps[m].name);
  render();
}

function getNext() {
  if (m+1 < practice[s].steps.length) return practice[s].steps[m+1];
  if (s+1 < practice.length) return practice[s+1].steps[0];
  return null;
}

function finishPractice() {
  pause();
  movementEl.textContent = "Session Complete ‚ö°";
  descEl.textContent = "You have upgraded your state.";
  bandhaEl.textContent = "Carry this energy.";
  timerEl.textContent = "Done";
  nextEl.textContent = "";
  phaseEl.textContent = "The Morning Alchemist";
  tripleBeep(); // Celebration beeps
  speak("Session Complete. Well done.");
}

// Initial Render
render();
</script>

</body>
</html>
